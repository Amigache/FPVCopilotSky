#!/bin/bash
# FPV Copilot Sky - Main CLI Interface
# Central command line tool for managing FPVCopilotSky system

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Get script directory (works even if called via symlink)
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd "$SCRIPT_DIR"

# Function to show header
show_header() {
    clear
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘${NC}  ${BOLD}âœˆï¸  FPV Copilot Sky - Management Console${NC}           ${CYAN}â•‘${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
}

# Function to show menu
show_menu() {
    show_header

    echo -e "${BOLD}${BLUE}ğŸ“¦ Installation & Deployment${NC}"
    echo -e "  ${GREEN}1)${NC} Install System Dependencies     - First-time setup"
    echo -e "  ${GREEN}2)${NC} Deploy to Production            - Build & deploy service"
    echo ""

    echo -e "${BOLD}${MAGENTA}ğŸ› ï¸  Development${NC}"
    echo -e "  ${GREEN}3)${NC} Start Development Mode          - Run with hot-reload"
    echo -e "  ${GREEN}4)${NC} Run Tests                       - Execute test suite"
    echo ""

    echo -e "${BOLD}${YELLOW}ğŸ“Š System Status & Diagnostics${NC}"
    echo -e "  ${GREEN}5)${NC} System Status                   - Check all components"
    echo -e "  ${GREEN}6)${NC} Pre-flight Check                - Comprehensive verification"
    echo -e "  ${GREEN}7)${NC} View Service Logs               - Real-time log monitoring"
    echo ""

    echo -e "${BOLD}${CYAN}âš™ï¸  Configuration${NC}"
    echo -e "  ${GREEN}8)${NC} Configure USB Modem             - Setup 4G/LTE modem"
    echo -e "  ${GREEN}9)${NC} Setup Serial Ports              - Configure MAVLink ports"
    echo -e " ${GREEN}10)${NC} Update Sudo Permissions         - Reconfigure sudoers"
    echo -e " ${GREEN}11)${NC} Test Network Management         - Verify network features"
    echo ""

    echo -e "${BOLD}${RED}ğŸ”§ Maintenance & Recovery${NC}"
    echo -e " ${GREEN}12)${NC} Rollback Network Changes        - Emergency recovery"
    echo -e " ${GREEN}13)${NC} Restart Service                 - Restart fpvcopilot-sky"
    echo -e " ${GREEN}14)${NC} Stop Service                    - Stop fpvcopilot-sky"
    echo ""

    echo -e "  ${GREEN}0)${NC} ${RED}Exit${NC}"
    echo ""
    echo -ne "${BOLD}Select an option [0-14]: ${NC}"
}

# Function to execute script
run_script() {
    local script_path=$1
    local description=$2

    echo ""
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}Executing: $description${NC}"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""

    if [ -f "$script_path" ]; then
        chmod +x "$script_path"
        bash "$script_path"
        local exit_code=$?

        echo ""
        echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        if [ $exit_code -eq 0 ]; then
            echo -e "${GREEN}âœ… Operation completed successfully${NC}"
        else
            echo -e "${RED}âŒ Operation failed (exit code: $exit_code)${NC}"
        fi
        echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    else
        echo -e "${RED}Error: Script not found: $script_path${NC}"
    fi

    echo ""
    read -p "Press Enter to continue..."
}

# Function to run command
run_command() {
    local command=$1
    local description=$2

    echo ""
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}Executing: $description${NC}"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""

    eval "$command"

    echo ""
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${GREEN}âœ… Operation completed${NC}"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    read -p "Press Enter to continue..."
}

# Main loop
while true; do
    show_menu
    read -r choice

    case $choice in
        1)
            run_script "install.sh" "System Installation"
            ;;
        2)
            run_script "scripts/deploy.sh" "Production Deployment"
            ;;
        3)
            run_script "scripts/dev.sh" "Development Mode"
            ;;
        4)
            run_script "test_runner.sh" "Test Suite"
            ;;
        5)
            run_script "scripts/status.sh" "System Status Check"
            ;;
        6)
            run_script "scripts/preflight-check.sh" "Pre-flight Verification"
            ;;
        7)
            run_command "sudo journalctl -u fpvcopilot-sky -f" "Service Logs"
            ;;
        8)
            run_script "scripts/configure-modem.sh" "USB Modem Configuration"
            ;;
        9)
            run_script "scripts/setup-serial-ports.sh" "Serial Port Setup"
            ;;
        10)
            run_script "scripts/setup-sudoers.sh" "Sudo Permissions Update"
            ;;
        11)
            run_script "scripts/test-network-management.sh" "Network Management Test"
            ;;
        12)
            echo ""
            echo -e "${RED}${BOLD}âš ï¸  WARNING: Emergency Recovery Operation${NC}"
            echo -e "${YELLOW}This will rollback recent network changes.${NC}"
            echo -e "${YELLOW}Only use if network is completely broken.${NC}"
            echo ""
            read -p "Are you sure? (yes/no): " confirm
            if [ "$confirm" = "yes" ]; then
                run_script "scripts/rollback-network-improvements.sh" "Network Rollback"
            else
                echo -e "${GREEN}Cancelled.${NC}"
                sleep 1
            fi
            ;;
        13)
            run_command "sudo systemctl restart fpvcopilot-sky" "Service Restart"
            ;;
        14)
            run_command "sudo systemctl stop fpvcopilot-sky" "Service Stop"
            ;;
        0)
            echo ""
            echo -e "${GREEN}ğŸ‘‹ Goodbye!${NC}"
            echo ""
            exit 0
            ;;
        *)
            echo ""
            echo -e "${RED}Invalid option. Please select 0-14.${NC}"
            sleep 2
            ;;
    esac
done
